<div metal:use-macro="main_template">

  <div metal:fill-slot="main_content" class="container">

    <div class="col-md-8">

      <div class="panel panel-primary">

        <div class="panel-heading">
          ${title} by ${performer.title|None}
        </div>

        <div class="panel-body">

          <div class="row">

            <div id="recording-video">
              <video id="thevideo" width="640" height="400" controls style="display: ${processed and 'block' or 'none'};">>
                <source src="${video_url}" type="video/mp4"/>
              </video>
              <div class="alert alert-success" role="alert" id="processing"
                   tal:condition="not processed">
                <span class="glyphicon glyphicon-refresh glyphicon-spin"></span>
                Recording is still being mixed.  Once it is finished
                being mixed, you will see it here.
              </div>
            </div>
          </div>

          <div class="row" tal:condition="other_recordings">
            <div class="panel panel-default">
              <div class="panel-heading">
                Other recordings of this song
              </div>
              <div class="panel-body">
                <table class="table table-striped table-condensed">

                  <tbody>
                    <tal:block repeat="item other_recordings">
                      <tr>
                        <td>
                          <img src="${item.performer.photo_url}" height="24"/>
                          <a style="margin-left: 20px;" href="${request.resource_url(item.performer)}">${item.performer.title}</a>
                        </td>
                        <td>
                          <a href="${request.resource_url(item)}">${layout.short_created_local(item)}</a>
                        </td>
                        <td>Likes: ${item.num_likes}</td>
                      </tr>
                    </tal:block>
                  </tbody>
                </table>
                
              </div>
            </div>


          </div>

          <div class="row" id="like-table" tal:define="can_like layout.can_like(context); has_liked layout.has_liked(context)">
            <div class="panel panel-default">
              <div class="panel-heading">
                 <span id="recording-feedback">
                   <tal:if tal:condition="can_like">
                     <a id="like-button" href="@@like" style="padding-left: 10px;"
                        ><i class="glyphicon glyphicon-thumbs-up"> </i></a>
                   </tal:if>
                   <tal:if condition="not can_like">
                     <a id="like-button" href="@@like" style="padding-left: 10px; display: none;"
                        ><i class="glyphicon glyphicon-thumbs-up"> </i></a>
                   </tal:if>
                   <tal:if tal:condition="has_liked">
                     <a id="unlike-button" href="@@unlike" style="padding-left: 10px;"
                        ><i class="glyphicon glyphicon-thumbs-down"> </i></a>
                   </tal:if>
                   <tal:if tal:condition="not has_liked">
                     <a id="unlike-button" href="@@unlike" style="padding-left: 10px; display: none;"
                        ><i class="glyphicon glyphicon-thumbs-down"> </i></a>
                   </tal:if>
                 </span>
                 <span id="like-count">${num_likes} performer${num_likes==1 and " has liked this recording" or "s have liked this recording"}</span>
                 <script type="text/javascript">
                  
                  $("#like-button").click(function () {
                    $.ajax('${request.resource_url(context)}@@like')
                      .success(function(data) {
                      if (data['num_likes'] == 1) {
                        message = data['num_likes'] + ' performer has liked this recording';
                      }
                      else {
                        message = data['num_likes'] + ' performers have liked this recording';
                      }
                      
                      $('#like-count').text(message);
                      $('#like-button').hide();
                      $('#unlike-button').show();
                    }).fail(function() {
                        alert('Failed to add like');
                      });
                      return false;
                    });
                      
                      
                  $("#unlike-button").click(function () {
                      $.ajax('${request.resource_url(context)}@@unlike')
                      .success(function(data) {
                          if (data['num_likes'] == 1) {
                            message = data['num_likes'] + ' performer has liked this recording';
                          }
                          else {
                            message = data['num_likes'] + ' performers have liked this recording';
                          }
                          
                  $('#like-count').text(message);
                  $('#unlike-button').hide();
                  if (data['can_like']) {
                    $('#like-button').show();
                  };
                  }).fail(function() {
                    alert('Failed to unlike');
                  });
                  return false;
                  });
                 </script>
              </div>

              <div class="panel-body">
                <table class="table table-striped table-condensed">
                  
                  <tbody>
                    <tr tal:repeat="item liked_by">
                      <td><img src="${item.photo_url}"/></td>
                      <td>
                        <a href="${request.resource_url(item)}">${item.title}</a>
                      </td>
                    </tr>
                  </tbody>
                </table>
                
              </div>
            </div>

          </div>

        </div>
      </div>

      <script type="text/javascript" tal:condition="not processed">
       var processcheck = function() {
         console.log('checking if recording processed');
         $.ajax(
           {
             "url":"${request.resource_url(context, 'has_processed')}",
             "success": function(data) {
               if (data['processed']) {
                 $('#thevideo').load();
                 $('#thevideo').show();
                 $('#processing').hide();
               }
               else {
                 setTimeout(processcheck,5000);
             }
           }
         }
       );
       }
       setTimeout(processcheck, 5000);
      </script>
    </div>

    <div class="col-md-4" tal:condition="False">

      <div class="panel panel-primary">

        <div class="panel-heading">
          Discussion
        </div>

        <div class="panel-body">

          <div class="row">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'youshouldsing'; // required: replace example with your forum shortname
                var disqus_id = '${context.__oid__}';
                var disqus_title = '${context.title}: ${context.performer.title|None}';
                var disqus_url = '${request.resource_url(context)}';

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

          </div>

        </div>

      </div>

    </div>

  </div>

</div>
