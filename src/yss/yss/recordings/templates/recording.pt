<div metal:use-macro="main_template">

  <div metal:fill-slot="main_content" class="container">

    <div class="row">

      <div class="col-md-12">

        <div class="panel panel-primary">

          <div class="panel-heading">
            <div class="row">
              <div class="col-md-9">
                <a href="${request.resource_url(context.song)}">${title}</a> by                 <a href="${request.resource_url(performer)"><img src="${layout.performer_thumb_url(performer)}" alt=""/> ${performer.__name__}</a>

              </div>
              <div class="col-md-3">
                <span metal:use-macro="layout.likes_macro"></span>
              </div>
            </div>
          </div>

          <div class="panel-body">

            <div class="row" style="padding-bottom: 10px;">
              <div class="col-md-8 col-md-offset-2">

                <div class="embed-responsive embed-responsive-4by3">

                  <video id="thevideo" controls width="640" height="480"
                         style="display: ${processed and 'inline-block' or 'none'};">
                    <source id="thevideosource" src="${video_url}" type="video/webm"/>
                  </video>

                  <div class="well" id="processing"
                       tal:condition="not processed">
                    <div class="progress">
                      <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%; min-width: 10em;" id="mixprogress">Awaiting mixing</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <div class="well">
                  <form method="GET"
                        action="${request.resource_url(context.song, '@@recordings')}">
                    <button id="other-recordings" type="submit"
                            style="width: 20em;"
                            class="btn btn-success">
                          Other recordings of this song
                    </button>
                  </form>
                </div>
              </div>


            </div>

          </div>

        </div>
      </div>

      <script type="text/javascript" tal:condition="not processed">
         var progresscheck = function() {
           console.log('progress check');
           var has_edit_permission = ${has_edit_permission};
           $.ajax(
             {
               "url":"${request.resource_url(context, '@@mixprogress')}",
               "success": function(data) {
                 if (data['done']) {
                   rand = Math.random().toString(36).replace(/[^a-z]+/g, ''
                                                             ).substr(0, 5);
                   $('#thevideosource')[0].setAttribute(
                     'src', "${video_url}?x=" + rand); // cachebust
                   var video = $('#thevideo');
                   video.load();
                   video.show();
                   $('#processing').hide();
                   if (has_edit_permission) {
                     $('#button-remix').show();
                     };
                 }
                 else {
                   $('#mixprogress').text(data['status']);
                   $('#mixprogress').attr('aria-valuenow', data['pct']);
                   $('#mixprogress').attr('style', 'width: ' + data['pct'] +'%; min-width: 10em;');
                   if (data['pct'] != -1) {
                     // if it's not in a terminal failure state, do it again
                     setTimeout(progresscheck, 2000); //every 2 secs
                   }
                 }
               }
             }
           );
           }
           setTimeout(progresscheck, 2000);
      </script>
    </div>

    <div class="row" tal:condition="False">

      <div class="col-md-12">

        <div class="panel panel-primary">

          <div class="panel-heading">
          Discussion
          </div>

          <div class="panel-body">

            <div class="row">
              <div class="col-md-12">
                <div id="disqus_thread"></div>
                <script>

                 var disqus_config = function () {
                   this.page.url = "${request.resource_url(context)}";
                   this.page.identifier = "${context.__oid__}";
                 };

                 (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = 'https://youshouldsing-1.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                  })();
                </script>
                <noscript>Please enable JavaScript to view the
                  <a href="https://disqus.com/?ref_noscript">comments
                    powered by Disqus.</a></noscript>

              </div>
            </div>
          </div>

        </div>

      </div>

    </div>

  </div>

  <div metal:fill-slot="tail">
    <script type="text/javascript"
            src="${layout.static('js/likes.js')}"></script>
    <script type="text/javascript">
     liker();
    </script>
    <script id="dsq-count-scr" src="//youshouldsing-1.disqus.com/count.js" async tal:condition="False"></script>
  </div>
</div>
